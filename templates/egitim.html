<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>ZorBaRa – Eğitim Modülü</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <h2 class="text-center mb-4">🧠 ZorBaRa Eğitim Modülü</h2>

    <div class="card p-4" id="task-box" style="min-height: 300px;">
      <h4 id="task-title">Yükleniyor...</h4>
      <div id="task-content" class="mb-3"></div>
      <div id="task-input" class="mb-3"></div>
      <button class="btn btn-success" onclick="submitAnswer()" id="submitBtn">Cevabı Gönder ✅</button>
      <div id="feedback" class="mt-3"></div>
      <button id="nextButton" onclick="nextTask()" style="display: none;" class="btn btn-primary mt-3">Sıradaki Göreve Geç ➡️</button>
    </div>
  </div>

  <script>
    let tasks = [];
    let currentTask = 0;

    fetch("/static/data/egitim_gorevleri.json")
      .then(response => response.json())
      .then(data => {
        tasks = data;
        loadTask();
      });

    function loadTask() {
      const task = tasks[currentTask];
      document.getElementById("task-title").innerText = task.title;
      document.getElementById("task-content").innerText = task.content;
      document.getElementById("feedback").innerText = "";
      document.getElementById("nextButton").style.display = "none";
      const inputDiv = document.getElementById("task-input");
      const submitBtn = document.getElementById("submitBtn");

      inputDiv.innerHTML = "";

      if (task.type === "quiz") {
        submitBtn.innerText = "Cevabı Gönder ✅";
        submitBtn.style.display = "inline-block";
        task.options.forEach((opt, index) => {
          inputDiv.innerHTML += `
            <div class="form-check">
              <input class="form-check-input" type="radio" name="quiz" id="opt${index}" value="${index}">
              <label class="form-check-label" for="opt${index}">${opt}</label>
            </div>
          `;
        });
      } else if (task.type === "text") {
        submitBtn.innerText = "Cevabı Gönder ✅";
        submitBtn.style.display = "inline-block";
        inputDiv.innerHTML = `
          <textarea class="form-control" id="text-answer" rows="3" placeholder="Cevabını yaz..."></textarea>
        `;
      } else if (task.type === "info") {
        submitBtn.innerText = "Devam Et ➡️";
        submitBtn.style.display = "inline-block";
        inputDiv.innerHTML = "";
      } else if (task.type === "end") {
        submitBtn.innerText = "Ana Sayfaya Dön ⬅️";
        submitBtn.style.display = "inline-block";
        inputDiv.innerHTML = "";
      }
    }

    function submitAnswer() {
      const task = tasks[currentTask];
      const feedbackDiv = document.getElementById("feedback");
      const nextBtn = document.getElementById("nextButton");

      if (task.type === "quiz") {
        const selected = document.querySelector('input[name="quiz"]:checked');
        if (!selected) {
          feedbackDiv.innerText = "Lütfen bir seçenek seç.";
          return;
        }
        if (task.correct.includes(parseInt(selected.value))) {
          feedbackDiv.innerHTML = "<span class='text-success'>✅ Doğru cevap!</span>";
          nextBtn.style.display = "inline-block";
        } else {
          feedbackDiv.innerHTML = "<span class='text-danger'>❌ Yanlış cevap. Tekrar dene.</span>";
        }

      } else if (task.type === "text") {
        const userText = document.getElementById("text-answer").value.trim();
        if (!userText || userText.length < 5) {
          feedbackDiv.innerHTML = `<span class='text-danger'>Lütfen anlamlı bir cevap yaz.</span>`;
          return;
        }

        feedbackDiv.innerHTML = "🧠 Cevabın değerlendiriliyor...";
        fetch("/evaluate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            soru: task.content,
            cevap: userText
          })
        })
        .then(res => res.json())
        .then(data => {
          const feedback = data.ai_feedback;

          if (!feedback || !feedback.puan || !feedback.geri_bildirim) {
            feedbackDiv.innerHTML = "<span class='text-danger'>Cevap alınamadı, lütfen tekrar dene.</span>";
            return;
          }

          feedbackDiv.innerHTML = `
            <p><strong>AI Değerlendirme: ${feedback.puan}/5 ⭐</strong></p>
            <p>${feedback.geri_bildirim}</p>
          `;
          nextBtn.style.display = "inline-block";
        })
        .catch(err => {
          console.error(err);
          feedbackDiv.innerHTML = "<span class='text-danger'>Bağlantı hatası. Lütfen tekrar dene.</span>";
        });

      } else if (task.type === "info" || task.type === "end") {
        nextTask();
      }
    }

    function nextTask() {
      document.getElementById("nextButton").style.display = "none";
      currentTask++;
      if (currentTask >= tasks.length) {
        window.location.href = "/";
      } else {
        loadTask();
      }
    }
  </script>
</body>
</html>
